<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GameCre8 — End-to-End Diagnostics</title>
<style>
  :root{--ok:#0a7;--err:#d33;--muted:#666;--card:#fff;--line:#eaeaea;--ink:#0b0f1a}
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#fafafa;color:var(--ink)}
  .wrap{max-width:960px;margin:24px auto;padding:0 16px}
  h1{font-size:22px;margin:14px 0} .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px;margin:12px 0}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{appearance:none;border:1px solid var(--line);background:#fff;border-radius:10px;padding:10px 12px;cursor:pointer}
  .btn.primary{background:#111;color:#fff;border-color:#111}
  .k{font-weight:600} .muted{color:var(--muted)} pre{background:#f6f6f6;border:1px solid #eee;border-radius:8px;padding:10px;overflow:auto}
  .ok{color:var(--ok)} .err{color:var(--err)} .dot{display:inline-block;width:8px;height:8px;border-radius:50%}
</style>
</head>
<body>
<div class="wrap">
  <h1>GameCre8 — End-to-End Diagnostics</h1>
  <div class="card">
    <div class="row">
      <button id="run" class="btn primary">Run Full Test</button>
      <button id="copy" class="btn">Copy Results</button>
      <span class="muted">This will check: app ➜ /api/health ➜ /api/templates ➜ /api/generate (dry) ➜ /api/evolve ➜ CORS ➜ Supabase (optional)</span>
    </div>
  </div>

  <div id="out" class="card"><div class="muted">Idle. Click “Run Full Test”.</div></div>
  <div class="card">
    <div class="muted">Tip: If a step fails, fix that one thing first, redeploy, and re-run.</div>
  </div>
</div>

<script>
(async function(){
  const $ = (sel)=>document.querySelector(sel);
  const out = $('#out');
  const append = (html)=>{ out.innerHTML += html; };
  const reset = ()=>{ out.innerHTML = ''; };
  const log = (label, ok, detail='')=>{
    append(`<div class="row"><span class="dot" style="background:${ok?'var(--ok)':'var(--err)'}"></span>
      <div><span class="k">${label}</span> — <span class="${ok?'ok':'err'}">${ok?'PASS':'FAIL'}</span>${detail?` <span class="muted">• ${detail}</span>`:''}</div></div>`);
  };
  const code = (obj)=>`<pre>${typeof obj==='string'?obj:escapeHtml(JSON.stringify(obj,null,2))}</pre>`;
  const escapeHtml=(s)=>String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));

  const base = location.origin;

  async function ping(url, opt={}){
    const res = await fetch(url, opt);
    const text = await res.text();
    let data; try{ data = JSON.parse(text); }catch{ data = text; }
    return { ok: res.ok, status: res.status, data, headers: Object.fromEntries(res.headers.entries()) };
  }

  async function run(){
    reset();
    append(`<div class="muted">Base: ${base}</div>`);

    // 0) App reachable
    log('0) App Reachable', true, 'Loaded diag.html');

    // 1) /api/health
    let h;
    try{
      h = await ping(`${base}/api/health`);
      log('1) /api/health', h.ok, `HTTP ${h.status}`);
      append(code(h.data));
      if(!h.ok) return;
    }catch(e){
      log('1) /api/health', false, e.message); return;
    }

    // 2) /api/templates
    let t;
    try{
      t = await ping(`${base}/api/templates`);
      log('2) /api/templates', t.ok, `HTTP ${t.status}`);
      append(code(t.data));
      if(!t.ok) return;
    }catch(e){
      log('2) /api/templates', false, e.message); return;
    }

    // 3) /api/generate (dry run)
    let g;
    try{
      g = await ping(`${base}/api/generate`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ prompt:'Diagnostics test', template: (Array.isArray(t.data)&&t.data[0]?.slug)||'blaster', dryRun:true })
      });
      log('3) /api/generate (dry)', g.ok, `HTTP ${g.status}`);
      append(code(g.data));
      if(!g.ok) return;
    }catch(e){
      log('3) /api/generate (dry)', false, e.message); return;
    }

    // 4) /api/evolve (only if generate returned a build/gameId)
    let gameId = (g.data && (g.data.gameId || g.data.id)) || null;
    if(gameId){
      let ev;
      try{
        ev = await ping(`${base}/api/evolve`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ gameId, choice:'double_lasers', dryRun:true })
        });
        log('4) /api/evolve (dry)', ev.ok, `HTTP ${ev.status}`);
        append(code(ev.data));
        if(!ev.ok) return;
      }catch(e){
        log('4) /api/evolve (dry)', false, e.message); return;
      }
    }else{
      log('4) /api/evolve (skipped)', true, 'No gameId in generate response');
    }

    // 5) CORS sanity (same-origin preflight)
    try{
      const c = await ping(`${base}/api/health`, { method:'GET', mode:'cors' });
      log('5) CORS check', c.ok, `HTTP ${c.status}`);
    }catch(e){
      log('5) CORS check', false, e.message); return;
    }

    // 6) Optional Supabase public object sanity (if you have a known public file)
    // If you have one, set it here once and this will verify public read:
    const samplePublic = ''; // e.g., 'https://XYZ.supabase.co/storage/v1/object/public/game-builds/health.txt'
    if(samplePublic){
      try{
        const s = await ping(samplePublic);
        log('6) Supabase public file', s.ok, `HTTP ${s.status}`);
      }catch(e){
        log('6) Supabase public file', false, e.message);
      }
    }else{
      log('6) Supabase public file', true, 'Skipped (no sample URL configured)');
    }

    append(`<div class="card" style="margin-top:12px"><div class="ok">Diagnostics complete.</div>
    <div class="muted">If a step failed above, fix just that one, redeploy (CI should do this automatically), then re-run.</div></div>`);
  }

  $('#run').addEventListener('click', run);
  $('#copy').addEventListener('click', ()=>{
    const tmp = document.createElement('textarea');
    tmp.value = out.innerText;
    document.body.appendChild(tmp); tmp.select(); document.execCommand('copy'); document.body.removeChild(tmp);
    alert('Results copied to clipboard.');
  });
})();
</script>
</body>
</html>
